---
title: "MASCBench"
author: "Rodrigo Bonif√°cio et al."
date: "1/26/2022"
output: 
  html_document:
    theme: cerulean
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd(".")
library(sqldf)
library(xtable)
```

## Load the datasets (including the ground truth for MASCBench)

```{r load}
bench03mop <- read.csv("../results/mop.csv", head=T, sep=",")
bench03cc  <- read.csv("../results/cognicrypt.csv", head=T, sep=",")
bench03cg <- read.csv("../results/cryptoguard.csv", head=T, sep=",")
bench03cy <- read.csv("../results/crylogger.csv", head=T, sep=",")


gt <- read.csv("../results/gt.csv", head=T, sep=",")

gt <- na.omit(gt)

```

### Filter out irrelevant warnings for the study

This is necessary because we have enriched the test cases for more complete scenarios, instead of just instantiating cryptographic primitives and then doing nothing with them. To solve this issue, we introduce the usage of Keys. 

```{r}
bench03mop <- sqldf("select * from bench03mop where spec != 'KeyGeneratorSpec'")
nrow(bench03mop)

bench03cc <- sqldf("select * from bench03cc  where spec != 'KeyGeneratorSpec'")
nrow(bench03cc)

bench03cy <- sqldf("select * from bench03cy  where spec in ('rule_R01', 'rule_R02')")
nrow(bench03cy)
```


## Identifying the sets of TPs and TNs

```{r}
tp <- gt[gt$vulnerability == "True",]
tn <- gt[gt$vulnerability == "False",]

sqldf("select count(distinct className) from tp")
sqldf("select count(distinct className) from tn")
```


## Computing Precision and Recall for MOP

```{r}

# compute true positive 

mop_tp <- sqldf("select count(distinct className) as tp
                 from bench03mop 
                 where className in (select className from tp)")

# compute false positive 

mop_fp <- sqldf("select count(distinct className) as fp
                 from bench03mop 
                 where className in (select className from tn)")

# compute false-negative  

mop_fn <- sqldf("select count(distinct className) as fn
                 from tp 
                 where className not in (select className from bench03mop)")

# MOP true positives
mop_tp

# MOP false positives
mop_fp

# MOP false negatives
mop_fn

precision_mop <- mop_tp$tp / (mop_tp$tp + mop_fp$fp)
precision_mop

recall_mop <- mop_tp$tp / (mop_tp$tp + mop_fn$fn)
recall_mop

fmeasure_mop = (2 * precision_mop * recall_mop) / (precision_mop + recall_mop)
fmeasure_mop
```

## Computing Precision and Recall for CC

```{r}

# compute true positive 

cc_tp <- sqldf("select count(distinct className) as tp
                 from bench03cc 
                 where className in (select className from tp)")

# compute false positive 

cc_fp <- sqldf("select count(distinct className) as fp
                 from bench03cc
                 where className in (select className from tn)")



# compute false-negative  

cc_fn <- sqldf("select count(distinct className) as fn
                 from tp 
                 where className not in (select className from bench03cc)")

# MOP true positives
cc_tp

# MOP false positives
cc_fp

# MOP false negatives
cc_fn

precision_cc <- cc_tp$tp / (cc_tp$tp + cc_fp$fp)
precision_cc

recall_cc <- cc_tp$tp / (cc_tp$tp + cc_fn$fn)
recall_cc

fmeasure_cc = (2 * precision_cc * recall_cc) / (precision_cc + recall_cc)
fmeasure_cc
```


## Computing Precision and Recall for CG

```{r}

# compute true positive 

cg_tp <- sqldf("select count(distinct className) as tp
                 from bench03cg
                 where className in (select className from tp)")

# compute false positive 

cg_fp <- sqldf("select count(distinct className) as fp
                 from bench03cg
                 where className in (select className from tn)")



# compute false-negative  

cg_fn <- sqldf("select count(distinct className) as fn
                 from tp 
                 where className not in (select className from bench03cg)")

# MOP true positives
cg_tp

# MOP false positives
cg_fp

# MOP false negatives
cg_fn

precision_cg <- cg_tp$tp / (cg_tp$tp + cg_fp$fp)
precision_cg

recall_cg <- cg_tp$tp / (cg_tp$tp + cg_fn$fn)
recall_cg

fmeasure_cg = (2 * precision_cg * recall_cg) / (precision_cg + recall_cg)
fmeasure_cg
```


## Computing Precision and Recall for CryLogger

```{r}

# compute true positive 

crylogger_tp <- sqldf("select count(distinct className) as tp
                 from bench03cy 
                 where className in (select className from tp)")

# compute false positive 

crylogger_fp <- sqldf("select count(distinct className) as fp
                 from bench03cy 
                 where className in (select className from tn)")



# compute false-negative  

crylogger_fn <- sqldf("select count(distinct className) as fn
                 from tp 
                 where className not in (select className from bench03cy)")

# crylogger true positives
crylogger_tp

# crylogger false positives
crylogger_fp

# crylogger false negatives
crylogger_fn


precision_cy <- crylogger_tp$tp / (crylogger_tp$tp + crylogger_fp$fp)
precision_cy

recall_cy <- crylogger_tp$tp / (crylogger_tp$tp + crylogger_fn$fn)
recall_cy

fmeasure_cy = (2 * precision_cy * recall_cy) / (precision_cy + recall_cy)
fmeasure_cy

```



## Accuracy Results for MASCBench

```{r table}

Tools = c("MOP", "CogniCrypt", "CryptoGuard", "CryLogger")
Precision = c(precision_mop, precision_cc, precision_cg, precision_cy)
Recall = c(recall_mop, recall_cc, recall_cg, recall_cy)
FMeasure = c(fmeasure_mop, fmeasure_cc, fmeasure_cg, fmeasure_cy)

analysis_ds = data.frame(Tools, Precision, Recall, FMeasure)

analysis_ds
```

## CWEs assessment 

```{r}
# RVSec

mop_tp <- sqldf("select distinct m.cwe as 'cwe', m.className as'ClassName', 'RVSec' as 'Tool', 'TP' as 'Warning'
                 from bench03mop m
                 where className in (select className from tp)")

# compute false positive 

mop_fp <- sqldf("select distinct m.cwe as 'cwe', m.className as'ClassName', 'RVSec' as 'Tool', 'FP' as 'Warning'
                 from bench03mop m
                 where className in (select className from tn)")

# compute false-negative  

mop_fn <- sqldf("select distinct t.cwe as 'cwe', t.className as'ClassName', 'RVSec' as 'Tool', 'FN' as 'Warning'
                 from tp t
                 where className not in (select className from bench03mop)")

nrow(mop_tp)
ds <- rbind(mop_tp, mop_fp)
ds <- rbind(ds, mop_fn)


# compute true positive 

cc_tp <- sqldf("select distinct c.cwe as 'cwe', c.className as'ClassName', 'CogniCrypt' as 'Tool', 'TP' as 'Warning'
                 from bench03cc c
                 where className in (select className from tp)")

# compute false positive 

cc_fp <- sqldf("select distinct c.cwe as 'cwe', c.className as'ClassName', 'CogniCrypt' as 'Tool', 'FP' as 'Warning'
                 from bench03cc c
                 where className in (select className from tn)")



# compute false-negative  

cc_fn <- sqldf("select distinct t.cwe as 'cwe', t.className as'ClassName', 'CogniCrypt' as 'Tool', 'FN' as 'Warning'
                 from tp t
                 where className not in (select className from bench03cc)")

ds <- rbind(ds, cc_tp)
ds <- rbind(ds, cc_fp)
ds <- rbind(ds, cc_fn)

# compute true positive 

cg_tp <- sqldf("select distinct c.cwe as 'cwe', c.className as'ClassName', 'CryptoGuard' as 'Tool', 'TP' as 'Warning'
                 from bench03cg c
                 where className in (select className from tp)")

# compute false positive 

cg_fp <- sqldf("select distinct c.cwe as 'cwe', c.className as'ClassName', 'CryptoGuard' as 'Tool', 'FP' as 'Warning'
                 from bench03cg c
                 where className in (select className from tn)")



# compute false-negative  

cg_fn <- sqldf("select distinct t.cwe as 'cwe', t.className as'ClassName', 'CryptoGuard' as 'Tool', 'FN' as 'Warning'
                 from tp t
                 where className not in (select className from bench03cg)")

ds <- rbind(ds, cg_tp)
ds <- rbind(ds, cg_fp)
ds <- rbind(ds, cg_fn)

# compute true positive 

crylogger_tp <- sqldf("select distinct c.cwe as 'cwe', c.className as'ClassName', 'CryLogger' as 'Tool', 'TP' as 'Warning'
                 from bench03cy c
                 where className in (select className from tp)")

nrow(crylogger_tp)
# compute false positive 

crylogger_fp <- sqldf("select distinct c.cwe as 'cwe', c.className as'ClassName', 'CryLogger' as 'Tool', 'FP' as 'Warning'
                 from bench03cy c
                 where className in (select className from tn)")



# compute false-negative  

crylogger_fn <- sqldf("select distinct t.cwe as 'cwe', t.className as'ClassName', 'CryLogger' as 'Tool', 'FN' as 'Warning'
                 from tp t
                 where className not in (select className from bench03cy)")

ds <- rbind(ds, crylogger_tp)
ds <- rbind(ds, crylogger_fp)
ds <- rbind(ds, crylogger_fn)


sqldf("select tool, warning, count(*) from ds group by tool, warning")

write.csv(ds, "../results/gt-cwes.csv",  row.names = FALSE)

```