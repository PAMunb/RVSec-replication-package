---
title: "ApacheCryptoAPIBench-Analysis-Fixed"
author: "Rodrigo Bonif√°cio et al."
date: "4/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=5, fig.path='./figures/', dev=c('png', 'pdf'))
setwd(".")
library(dplyr)
library(sqldf)
library(xtable)
library(lattice)
library(ggvenn)
library(corrplot)
```

## Load the ApacheBench DataSet

```{r load}
final_ds <- read.csv("../results/gt-FIXED-new.csv", head=T, sep=',')
colnames(final_ds)

##  [1] "Project"         "Spec"            "Class"           "Method"         
##  [5] "Tool"            "Vulnerability"   "RelatedWarnings" "TestClass"      
##  [9] "ExternalClass"   "Observation"
```

## Data CleanUp

### Remove duplicated records

```{r remove-dups}
final_ds = distinct(final_ds)
```

### Count the number of warnings and group them by tool 

```{r total-rows}
nrow(final_ds)

t1 = sqldf("select Tool, count(*) as FullDataSet
       from final_ds 
       group by Tool")
```

### Count warnings from external libraries (and remove them from our analysis)

```{r remove-external-observations}
sqldf("select count(*) 
       from final_ds 
      where Vulnerability = '-'")

final_ds = sqldf("select *
                  from final_ds 
                  where Vulnerability != '-'")

nrow(final_ds)
```

### Removing warnings from test cases 

```{r remove-test-observations}
sqldf("select TestClass, count(*) 
       from final_ds 
       group by TestClass")


final_ds = sqldf("select *
                  from final_ds 
                  where TestClass = FALSE")

nrow(final_ds)

t2 = sqldf("select Tool, count(*) as CuratedDataSet
       from final_ds 
       group by Tool")


xtable(merge(t1, t2))

sqldf("select spec, count(*) total 
       from final_ds
       group by spec")

sqldf("select Project, count(*) 
       from final_ds 
       group by project")

```

## Exploratory Data Analysis 

### Total Warnings (grouped by Project and Tool)

```{r warnings-projects}
warnings_projects = sqldf("select Project, Tool, count(*) as Warnings
                           from final_ds group by Project, Tool")

warnings_projects

barchart(Warnings ~ Tool | Project, 
  data = warnings_projects, stack = T, xlab="Tool"
)
```

## Compute the set of True Positives

```{r true-positives}
tp = sqldf("select distinct Project, Spec, Class, Method, CWE
            from final_ds 
            where Vulnerability = 'TRUE'
            order by 1,2,3,4")

sqldf("select count(distinct class) from tp")

nrow(tp)
```

## MOP Precision and Recal

```{r mop-assessment}
mop_tp = sqldf("select distinct Project, Spec, Class, Method, CWE 
                from final_ds 
               where Tool = 'RV' and Vulnerability = 'TRUE'")

mop_fp = sqldf("select distinct Project, Spec, Class, Method, CWE 
                from final_ds 
                where Tool = 'RV' and Vulnerability = 'FALSE'")

mop_fn = setdiff(tp, mop_tp)

mop_precision = nrow(mop_tp) / (nrow(mop_tp) + nrow(mop_fp))
mop_recall = nrow(mop_tp) / (nrow(mop_tp) + nrow(mop_fn))
mop_fmeasure = 2 * ((mop_precision * mop_recall) / (mop_precision + mop_recall))

nrow(mop_tp)
nrow(mop_fp)
nrow(mop_fn)
mop_precision
mop_recall
mop_fmeasure
```

### CC Precision and Recal

```{r cc-assessment}
cc_tp = sqldf("select distinct Project, Spec, Class, Method, CWE 
                from final_ds 
               where Tool = 'CogniCrypt' and Vulnerability = 'TRUE'")

cc_fp = sqldf("select distinct Project, Spec, Class, Method, CWE 
                from final_ds 
                where Tool = 'CogniCrypt' and Vulnerability = 'FALSE'")

cc_fn = setdiff(tp, cc_tp)

cc_precision = nrow(cc_tp) / (nrow(cc_tp) + nrow(cc_fp))
cc_recall = nrow(cc_tp) / (nrow(cc_tp) + nrow(cc_fn))
cc_fmeasure = 2 * ((cc_precision * cc_recall) / (cc_precision + cc_recall))

nrow(cc_tp)
nrow(cc_fp)
nrow(cc_fn)
cc_precision
cc_recall
cc_fmeasure
```

### CG Precision and Recal

```{r cg-assessment}
cg_tp = sqldf("select distinct Project, Spec, Class, Method, CWE 
                from final_ds 
               where Tool = 'CryptoGuard' and Vulnerability = 'TRUE'")

cg_fp = sqldf("select distinct Project, Spec, Class, Method, CWE 
                from final_ds 
                where Tool = 'CryptoGuard' and Vulnerability = 'FALSE'")

cg_fn = setdiff(tp, cg_tp)

nrow(cg_tp)
nrow(cg_fp)
nrow(cg_fn)


cg_precision = nrow(cg_tp) / (nrow(cg_tp) + nrow(cg_fp))
cg_recall = nrow(cg_tp) / (nrow(cg_tp) + nrow(cg_fn))
cg_fmeasure = 2 * ((cg_precision * cg_recall) / (cg_precision + cg_recall))

cg_precision
cg_recall
cg_fmeasure
```

### Load the CryLogger datasets  

```{r load-crylogger}
clogger_deltaspyke <- read.csv("../results/crylogger/CryLogger-deltaspyke.csv", head=T, sep=",")
clogger_mcf <- read.csv("../results/crylogger/CryLogger-mcf-core.csv", head=T, sep=",")
clogger_meecrowave <- read.csv("../results/crylogger/CryLogger-meecrowave-core.csv", head=T, sep=",")
clogger_ds_kerberos_codec <- read.csv("../results/crylogger/CryLogger-apacheds-kerberos-codec.csv", head=T, sep=",")
clogger_tika <- read.csv("../results/crylogger/CryLogger-tika-core.csv", head=T, sep=",")


clogger_deltaspyke <- sqldf("select distinct spec, cwe, class, classname, method from clogger_deltaspyke")
clogger_mcf <- sqldf("select distinct spec, cwe, class, classname, method from clogger_mcf")
clogger_meecrowave <- sqldf("select distinct spec, cwe, class, classname, method from clogger_meecrowave")
clogger_ds_kerberos_codec <- sqldf("select distinct spec, cwe, class, classname, method from clogger_ds_kerberos_codec")
clogger_tika <- sqldf("select distinct spec, cwe, class, classname, method from clogger_tika")


clogger <- rbind(clogger_mcf, clogger_meecrowave)
clogger <- rbind(clogger, clogger_ds_kerberos_codec)
clogger <- rbind(clogger, clogger_tika)
clogger <- rbind(clogger,clogger_deltaspyke)

colnames(clogger)
colnames(final_ds)

```

### Approximate the CryLogger outcomes with the ground truth

```{r}
gt_clogger <- sqldf("select distinct spec, project, class as 'className', method, vulnerability , cwe
                     from final_ds")

nrow(final_ds)
nrow(gt_clogger)

head(gt_clogger)

cl_tp <- sqldf("select distinct c.className, c.method, c.cwe
                from clogger c, gt_clogger cgt 
               where c.className = cgt.className 
                and c.method = cgt.method
                and vulnerability =  'TRUE'")

cl_fp <- sqldf("select distinct c.className, c.method, c.cwe
                from clogger c 
               where (c.className, c.method) not in 
                 (select cgt.className, cgt.method 
                  from gt_clogger cgt
                  where vulnerability =  'TRUE')")

cl_fn <- sqldf("select distinct cgt.className, cgt.method, cgt.cwe
             from gt_clogger cgt
             where vulnerability =  'TRUE' 
               and (cgt.className, cgt.method) not in 
                     (select c.className, c.method 
                      from clogger c)")



cl_precision = nrow(cl_tp) / (nrow(cl_tp) + nrow(cl_fp))
cl_recall = nrow(cl_tp) / (nrow(cl_tp) + nrow(cl_fn))
cl_fmeasure = 2 * ((cl_precision * cl_recall) / (cl_precision + cl_recall))

cl_precision
cl_recall
cl_fmeasure

```

## Accuracy Results for ApacheCryptoBench

```{r table}
Tools = c("MOP", "CogniCrypt", "CryptoGuard", "CryLogger")
Precision = c(mop_precision, cc_precision, cg_precision, cl_precision)
Recall = c(mop_recall, cc_recall, cg_recall, cl_recall)
FMeasure = c(mop_fmeasure, cc_fmeasure, cg_fmeasure, cl_fmeasure)

analysis_ds = data.frame(Tools, Precision, Recall, FMeasure)

analysis_ds
```

## CWEs assessment

```{r}
mop <- sqldf("select distinct cwe as 'cwe',  class as 'className', 'RVSec' as tool, 'TP' as warning from mop_tp")
mop <- rbind(mop, sqldf("select distinct cwe as 'cwe',  class as 'className', 'RVSec' as tool, 'FP' as warning from mop_fp"))
mop <- rbind(mop, sqldf("select distinct cwe as 'cwe',  class as 'className', 'RVSec' as tool, 'FN' as warning from mop_fn"))

cc <- sqldf("select distinct cwe as 'cwe',  class as 'className', 'CogniCrypt' as tool, 'TP' as warning from cc_tp")
cc <- rbind(cc, sqldf("select distinct cwe as 'cwe',  class as 'className', 'CogniCrypt' as tool, 'FP' as warning from cc_fp"))
cc <- rbind(cc, sqldf("select distinct cwe as 'cwe',  class as 'className', 'CogniCrypt' as tool, 'FN' as warning from cc_fn"))

cg <- sqldf("select distinct cwe as 'cwe',  class as 'className', 'CryptoGuard' as tool, 'TP' as warning from cg_tp")
cg <- rbind(cg, sqldf("select distinct cwe as 'cwe',  class as 'className', 'CryptoGuard' as tool, 'FP' as warning from cg_fp"))
cg <- rbind(cg, sqldf("select distinct cwe as 'cwe',  class as 'className', 'CryptoGuard' as tool, 'FN' as warning from cg_fn"))

cl <- sqldf("select distinct cwe as 'cwe',  className as 'className', 'CryLogger' as tool, 'TP' as warning from cl_tp")
cl <- rbind(cl, sqldf("select distinct cwe as 'cwe',  className as 'className', 'CryLogger' as tool, 'FP' as warning from cl_fp"))
cl <- rbind(cl, sqldf("select distinct cwe as 'cwe',  className as 'className', 'CryLogger' as tool, 'FN' as warning from cl_fn"))


ds <- rbind(mop, cc)
ds <- rbind(ds, cg)
ds <- rbind(ds, cl)


write.csv(ds, "../results/gt-cwes.csv",  row.names = FALSE)

```

### Venn Diagram

```{r vd}
tp_warnings = sqldf("select distinct (Project || '-' || Spec || '-' || Class|| '-' || Method) as Warning
                      from final_ds 
                      where Vulnerability = 'TRUE'")
  
sets = sqldf("select Tool, (Project || '-' || Spec || '-' || Class|| '-' || Method) as Warning, count(*) as total
                  from final_ds 
                  group by Tool, Warning")


tp = tp_warnings[, c("Warning")]
rv = sets[sets$Tool=="RV", c("Warning")]
cc = sets[sets$Tool=="CogniCrypt", c("Warning")]
cg = sets[sets$Tool=="CryptoGuard", c("Warning")]

length(tp)
length(rv)
length(cc)
length(cg)

x <- list(
  TP = tp,
  RV= rv,
  CogniCrypt = cc, 
  CryptoGuard = cg
)

ggvenn(
 x,
 fill_color = c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF"),
   stroke_size = 0.7, set_name_size = 3.5, text_size=3
)

```

```{r interesting-cases}

sets_diff = setdiff(mop_tp, cc_tp)

nrow(sets_diff)
sets_diff
```


### Precision and Recall per-project (MOP)

```{r pr-by-project}
mop_tp = sqldf("select Project, count(*) as TP
                from final_ds 
                 where Tool = 'RV' and Vulnerability = 'TRUE' group by Project")

mop_tp

mop_fp = sqldf("select Project, count(*) as FP
                from final_ds 
                where Tool = 'RV' and Vulnerability = 'FALSE' group by Project")

mop_fp

mop_fn = sqldf("select Project, count(*) as FN from mop_fn group by Project")

mop_fn 

mop_precision_recall = full_join(mop_tp, mop_fp)
mop_precision_recall = full_join(mop_precision_recall, mop_fn)


mop_precision_recall[is.na(mop_precision_recall)] <- 0


mop_precision_recall["Precision"] = mop_precision_recall$TP / (mop_precision_recall$TP + mop_precision_recall$FP)
mop_precision_recall["Recall"] = mop_precision_recall$TP / (mop_precision_recall$TP + mop_precision_recall$FN)
mop_precision_recall["FMeasure"] = 2 * (mop_precision_recall$Precision * mop_precision_recall$Recall) / (mop_precision_recall$Precision + mop_precision_recall$Recall)


mop_precision_recall


```


### Coverage Assessment

```{r correlation-coverage}
projects <- read.csv("../results/projects.csv")


apachedsKerberosCodecCoverage <- read.csv("../results/jacoco-apacheds-kerberos-codec.csv", sep=",", header = T)
artemisCommonsCodecCoverage <- read.csv("../results/jacoco-artemis-commons.csv", sep=",", header = T)
deltaSpikeCoreCodeCoverage <- read.csv("../results/jacoco-deltaspike-core-impl.csv", sep=",", header = T)
mcfCoreCodeCoverage <- read.csv("../results/jacoco-mcf-core.csv", sep=",", header = T)
meecrowaveCoreCodeCoverage <- read.csv("../results/jacoco-meecrowave-core.csv", sep=",", header=T)
sparkCoreCodeCoverage <- read.csv("../results/jacoco-spark-core_2.11.csv", sep=",", header=T)
tikaCoreCodeCoverage <- read.csv("../results/jacoco-tika-core.csv", sep=",", header=T)
wicketUtilCodeCoverage <- read.csv("../results/jacoco-wicket-util.csv", sep=",", header=T)

codeCoverage <- rbind(apachedsKerberosCodecCoverage, artemisCommonsCodecCoverage)
codeCoverage <- rbind(codeCoverage, deltaSpikeCoreCodeCoverage)
codeCoverage <- rbind(codeCoverage, mcfCoreCodeCoverage)
codeCoverage <- rbind(codeCoverage, sparkCoreCodeCoverage)
codeCoverage <- rbind(codeCoverage, tikaCoreCodeCoverage)
codeCoverage <- rbind(codeCoverage, wicketUtilCodeCoverage)

nrow(codeCoverage)

codeCoverage = merge(projects, codeCoverage, by.x = "group", by.y = "GROUP")


names(codeCoverage)[1] <- "project"
colnames(codeCoverage)
nrow(codeCoverage)

##  [1] "group"               "module"              "latex"              
##  [4] "test_cases"          "PACKAGE"             "CLASS"              
##  [7] "INSTRUCTION_MISSED"  "INSTRUCTION_COVERED" "BRANCH_MISSED"      
## [10] "BRANCH_COVERED"      "LINE_MISSED"         "LINE_COVERED"       
## [13] "COMPLEXITY_MISSED"   "COMPLEXITY_COVERED"  "METHOD_MISSED"      
## [16] "METHOD_COVERED"

sqldf("select count(distinct class) 
      from codeCoverage") 

cc_summary <- sqldf("select project, module, latex, test_cases, 
              avg(instruction_covered/(instruction_covered + instruction_missed) * 100) as IC,
              avg(branch_covered/(branch_covered + branch_missed) * 100) as BC,
              avg(method_covered/(method_covered + method_missed) * 100) as MC
        from codeCoverage 
        group by project, module, latex, test_cases")

cc_summary

module_name = c("ArtemisCommons", "DeltaSpikeCore", "ApachedsKerberosCodec", "SparkCore", "WicketUtil")
accuracy = c(1.0, 1.0, 0.84, 0.90, 0.85)

accuracy_ds = data.frame(module_name, accuracy)
accuracy_ds

colnames(accuracy_ds) = c("module", "accuracy")


cc_summary = merge(cc_summary, accuracy_ds)

cc_summary

corrmatrix = sqldf("select test_cases, IC, BC, MC, accuracy
                    from cc_summary")


colnames(corrmatrix) <- c("TCs", "IC", "BC", "MC", "Accuracy")

M = cor(corrmatrix)

corrplot(M, method = 'number', type='lower')
corrplot(M, order = 'AOE')
corrplot(M, method = 'square', order = 'FPC', type = 'lower', diag = FALSE)

```